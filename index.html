<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/node-uuid/1.4.8/uuid.min.js"></script>
</head>
<style>
    .App {
        font-family: sans-serif;
    }

    .TimeBoxEditor,
    .TimeBoxCreator {
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 1px solid gray;
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 20px;
    }

    input {
        min-width: 60%;
        margin-left: 20px;
        margin: 10px;
        font-size: 16px;
    }

    button {
        font-size: 16px;
        margin: 10px;
    }

    .TimeBox {
        border: 1px solid gray;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        text-align: left;
    }

    .CurrentTimeBox {
        border: 1px solid gray;
        border-radius: 5px;
        padding: 20px;
        text-align: center;
    }

    .Clock {
        color: orangered;
    }

    .ProgressBar {
        display: flex;
        justify-content: flex-start;
        border: 1px solid orangered;
        border-radius: 5px;
        height: 25px;
        margin-bottom: 20px;
    }

    .ProgressBar.reverse {
        justify-content: flex-end;
    }

    .ProgressBar>div {
        height: 100%;
        background-color: orangered;
    }

    .inactive {
        filter: blur(2px) grayscale(1);
    }
</style>

<body>
    <div class="App">
    </div>
    <div id="root"></div>
</body>
<script type="text/babel">
    function Clock({ className = "", hours = 0, minutes = 0, seconds = 0, miliseconds = 0 }) {
        const properTime = (time) => {
            if (0 > time || time > 60) {
                return (time > 60) ? '59' : '00';
            }
            time = '0' + time;
            return (time.length > 2) ? time.slice(1) : time;
        }
        const properHour = (time) => {
            if (0 > time || time > 24) {
                return (time > 24) ? '24' : '00';
            }
            time = '0' + time;
            return (time.length > 2) ? time.slice(1) : time;
        }
        const properMili = (time) => {
            if (0 > time || time > 999) {
                return (time > 999) ? '999' : '000';
            }
            time = '00' + time;
            return (time.length > 3) ? time.slice(time.length - 3) : time;
        }
        const clockNumbers = () => {
            return `${properHour(hours)}:${properTime(minutes)}:${properTime(seconds)}.${properMili(miliseconds)}`
        }
        return <h2 className={"Clock " + className}>{clockNumbers()}</h2>
    }



    function ProgressBar({ className = "", percent = 0, trackRemaining = false }) {
        percent = (trackRemaining) ? 100 - percent : percent
        return (

            <div className={`ProgressBar ${className} ${trackRemaining ? 'reverse' : ''}`}>
                <div style={{ width: `${percent}%` }}></div>
            </div>
        )
    }

    class TimeBoxEditor extends React.Component {
        render() {
            const { title, totalTimeInMinutes, onTitleChange, onTotalTimeMinuteChange, onConfirm, isEditable } = this.props;
            return (
                <div className={`TimeBoxEditor ${isEditable ? "" : "inactive"}`}>
                    <label>
                        Co robisz?
                        <input
                            value={title}
                            disabled={!isEditable}
                            onChange={onTitleChange}
                            type="text" />
                    </label>
                    <br />
                    <label>Ile minut?
                        <input
                            value={totalTimeInMinutes}
                            disabled={!isEditable}
                            onChange={onTotalTimeMinuteChange}
                            type="text" />
                    </label>
                    <br />
                    <button
                        disabled={!isEditable}
                        onClick={onConfirm}
                    >Zatwierdź zmiany</button>
                </div>
            )
        }
    }

    class TimeBoxCreator extends React.Component {

        constructor(props) {
            super(props);
            this.titleInput = React.createRef();
            this.totalTimeInMinutesInput = React.createRef();
            this.form = React.createRef();
        }

        // Controled Component
        // state = {
        //     title: "",
        //     totalTimeInMinutes: 0,
        // };

        // handleTitleChange = (event) => {
        //     this.setState({ title: event.target.value });
        // };

        // handleTotalTimeChange = (event) => {
        //     this.setState({ totalTimeInMinutes: event.target.value });
        // };

        // handleSubmit = (event) => {
        //     const { title, totalTimeInMinutes } = this.state;
        //     event.preventDefault();
        //     this.props.onCreate({ id: uuid.v4(), title, totalTimeInMinutes });
        //     this.setState({ title: "", totalTimeInMinutes: 0 })
        // };


        // Not controlled way
        handleSubmit = (event) => {
            const { title, totalTimeInMinutes } = this.form.current.elements;
            event.preventDefault();
            this.props.onCreate({
                id: uuid.v4(),
                title: title.value,
                totalTimeInMinutes: totalTimeInMinutes.value,
            });
            title.value = "";
            totalTimeInMinutes.value = "";
        };

        render() {
            return (
                <form ref={this.form} onSubmit={this.handleSubmit} className={`TimeBoxCreator`}>
                    <label>
                        Co robisz?
                            <input
                            id="title"
                            ref={this.titleInput}
                            type="text" />
                    </label>
                    <br />
                    <label>Ile minut?
                            <input
                            id="totalTimeInMinutes"
                            ref={this.totalTimeInMinutesInput}
                            type="number" />
                    </label>
                    <br />
                    <button>Dodaj timebox</button>
                </form>
            )
        }
    }

    class TimeBoxList extends React.Component {

        state = {
            timeboxes: [
                { id: uuid.v4(), title: 'test', totalTimeInMinutes: 10 },
                { id: uuid.v4(), title: 'test2', totalTimeInMinutes: 5 },
                { id: uuid.v4(), title: 'test3', totalTimeInMinutes: 1 },
            ]
        }

        addTimeBox = (timeBox) => {
            this.setState(prevState => {
                // const timeboxes = [...prevState.timeboxes, timeBox];
                const timeboxes = prevState.timeboxes.concat([timeBox]);
                return { timeboxes };
            })
        }

        removeTimeBox = (indexOfTimeBox) => {
            this.setState(prevState => {
                // const timeboxes = prevState.timeboxes.filter((timebox, index) => index !== indexOfTimeBox);
                const timeboxes = prevState.timeboxes;
                timeboxes.splice(indexOfTimeBox, 1);
                return { timeboxes };
            })
        }

        updateTiemBox = (updatedTiemBox) => {
            this.setState(prevState => {
                const timeboxes = prevState.timeboxes.map((timebox) => {
                    return timebox.id === updatedTiemBox.id ? updatedTiemBox : timebox;
                });
                return { timeboxes };
            })
        }

        handleCreate = (timeBoxCreated) => {
            this.addTimeBox(timeBoxCreated)
        }



        render() {
            const { timeboxes } = this.state;
            return (
                <>
                    <TimeBoxCreator onCreate={this.handleCreate} />
                    {timeboxes.map((timeBox, index) =>
                        (<TimeBox
                            onDelete={() => this.removeTimeBox(index)}
                            onEdit={this.updateTiemBox}
                            key={timeBox.id}
                            id={timeBox.id}
                            title={timeBox.title}
                            totalTimeInMinutes={timeBox.totalTimeInMinutes} />
                        )
                    )}


                </>
            )
        };
    }

    class CurrentTimeBox extends React.Component {

        constructor(props) {
            super(props);
            this.state = {
                isRunning: false,
                isPaused: false,
                pasueCount: 0,
                elapsedTimeInSeconds: 0
            }
            this.handleStop = this.handleStop.bind(this);
        }

        handleStart(event) {
            this.setState(
                {
                    isRunning: true
                }
            )
            this.startTimer()
        }

        togglePause(event) {
            this.setState(
                function (prevState) {
                    const isPaused = !prevState.isPaused;
                    if (isPaused) {
                        this.stopTimer();
                    } else {
                        this.startTimer();
                    }
                    return {
                        isPaused,
                        pasueCount: isPaused ? prevState.pasueCount + 1 : prevState.pasueCount
                    }
                }
            )
            this.stopTimer();
        }

        handleStop() {
            this.stopTimer();
            this.setState({
                isRunning: false,
                isPaused: false,
                pasueCount: 0,
                elapsedTimeInSeconds: 0
            });

        }

        startTimer() {
            this.intervalId = window.setInterval(
                () => {
                    this.setState(
                        (prevState) => ({ elapsedTimeInSeconds: prevState.elapsedTimeInSeconds + 0.01 })
                    )
                }, 10
            )
        }



        stopTimer() {
            window.clearInterval(this.intervalId);
        }

        render() {
            const { isRunning, isPaused, pasueCount, elapsedTimeInSeconds } = this.state;
            const { title, totalTimeInMinutes, isEditable, onEdit } = this.props;
            const totalTimeInSeconds = totalTimeInMinutes * 60;
            const timeLeftInSeconds = totalTimeInSeconds - elapsedTimeInSeconds;
            const minutes = Math.floor(timeLeftInSeconds / 60);
            const seconds = Math.floor(timeLeftInSeconds % 60);
            const progressInPercent = elapsedTimeInSeconds / totalTimeInSeconds * 100;

            if (timeLeftInSeconds < 0) {
                this.handleStop();
            }






            return (
                <div className={`TimeBox ${isEditable ? "inactive" : ""}`}>
                    <h1>{title}</h1>
                    <Clock seconds={seconds} minutes={minutes} className={isPaused ? 'inactive' : ''} />
                    <ProgressBar percent={progressInPercent} className={isPaused ? 'inactive' : ''} />
                    <button onClick={onEdit} disabled={isEditable} >Edytuj</button>
                    <button onClick={() => this.handleStart()} disabled={isRunning} >Start</button>
                    <button onClick={this.handleStop} disabled={!isRunning}>Stop</button>
                    <button onClick={() => this.togglePause()} disabled={!isRunning}>{(isPaused) ? 'Wznów' : 'Pauza'}</button>
                    liczba przerw: {pasueCount}
                </div>
            )
        }
    }


    class EditableTimeBox extends React.Component {

        state = {
            title: "Ucze się Reacta",
            isEditable: true,
            totalTimeInMinutes: 15
        }

        handleConfirm = () => {
            this.setState({ isEditable: false })
        }

        handleTitleChange = (event) => {
            this.setState({ title: event.target.value })
        }

        handleTotalTimeMinutesChange = (event) => {
            this.setState({ totalTimeInMinutes: event.target.value })
        }

        handleEdit = () => {
            this.setState({ isEditable: true })
        }

        render() {
            const { title, totalTimeInMinutes, isEditable } = this.state;
            return (
                <>
                    <TimeBoxEditor
                        title={title}
                        isEditable={isEditable}
                        totalTimeInMinutes={totalTimeInMinutes}
                        onConfirm={this.handleConfirm}
                        onTitleChange={this.handleTitleChange}
                        onTotalTimeMinuteChange={this.handleTotalTimeMinutesChange} />
                    <CurrentTimeBox
                        title={title}
                        isEditable={isEditable}
                        onEdit={this.handleEdit}
                        totalTimeInMinutes={totalTimeInMinutes}
                    />
                </>
            )
        }
    }

    class TimeBox extends React.Component {

        state = {
            isEditable: false,
        };

        handleEditableChange = () => {
            this.setState(prevState => ({ isEditable: !prevState.isEditable }))
        }

        onTitleChange = (event) => {
            const { onEdit, id, totalTimeInMinutes } = this.props;
            const title = event.target.value;
            onEdit({ title, totalTimeInMinutes, id });
        }

        onTotalTimeMinuteChange = (event) => {
            const { onEdit, id, title } = this.props;
            const totalTimeInMinutes = event.target.value;
            onEdit({ title, totalTimeInMinutes, id });
        }

        render() {
            const { title, totalTimeInMinutes, onDelete } = this.props;
            const { isEditable } = this.state;
            return (
                <div className="TimeBox">
                    {isEditable
                        ? (<>
                            <input onChange={this.onTitleChange} value={title} type="text" />
                            <input onChange={this.onTotalTimeMinuteChange} value={totalTimeInMinutes} type="number" />
                        </>)
                        :
                        <h3>{title}-{totalTimeInMinutes}</h3>}
                    <button onClick={onDelete}>Usuń</button>
                    <button onClick={this.handleEditableChange}> {isEditable ? 'Zatwierdź' : 'Edytuj'}</button>
                </div>
            )
        }
    }

    function App() {
        return (
            <div className="App">
                <h1>Kurs React Tydzien 2</h1>
                <hr />
                <TimeBoxList />
            </div>
        )
    }

    ReactDOM.render(<App />, document.getElementById('root'));


</script>

</html>